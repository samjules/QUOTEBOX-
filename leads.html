<script>
const SUPABASE_URL = 'https://jpchpqjnyabtpptufkcj.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let accountId = null;
let allLeads = [];

// --- Check if user is signed in ---
async function checkAuth() {
    console.log('[Auth] Checking user auth...');
    const { data } = await supabase.auth.getUser();
    const user = data.user;

    if (!user) {
        console.log('[Auth] No user signed in, redirecting to login.');
        window.location.href = 'login.html';
        return;
    }

    console.log('[Auth] User signed in:', user.id);

    // Get account for this user
    const { data: account, error } = await supabase
        .from('accounts')
        .select('*')
        .eq('owner_id', user.id)
        .single();

    if (error) {
        console.error('[Account] Error fetching account:', error);
        alert('No account found for this user.');
        return;
    }

    console.log('[Account] Account found:', account);
    accountId = account.id;

    loadLeads();
}

// --- Load leads for this account ---
async function loadLeads() {
    console.log('[Leads] Loading leads for accountId:', accountId);
    const { data: leads, error } = await supabase
        .from('leads')
        .select('*')
        .eq('account_id', accountId)
        .order('created_at', { ascending: false });

    if (error) {
        console.error('[Leads] Error fetching leads:', error);
        return;
    }

    console.log(`[Leads] Loaded ${leads.length} leads`, leads);
    allLeads = leads;
    renderLeads(leads);
}

// --- Render leads in table ---
function renderLeads(leads) {
    console.log('[Render] Rendering', leads.length, 'leads');
    const tbody = document.getElementById('leadsTable');
    tbody.innerHTML = '';

    leads.forEach(lead => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${lead.name || '-'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lead.email || '-'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lead.phone || '-'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lead.form_type || '-'}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <select class="status-dropdown text-xs leading-5 font-semibold rounded-full px-2 py-1 ${getStatusColor(lead.status)}" data-lead-id="${lead.id}" data-current-status="${lead.status}">
                    <option value="new" ${lead.status === 'new' ? 'selected' : ''}>New</option>
                    <option value="contacted" ${lead.status === 'contacted' ? 'selected' : ''}>Contacted</option>
                    <option value="booked" ${lead.status === 'booked' ? 'selected' : ''}>Booked</option>
                    <option value="lost" ${lead.status === 'lost' ? 'selected' : ''}>Lost</option>
                </select>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(lead.created_at).toLocaleDateString()}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <button class="view-btn text-indigo-600 hover:text-indigo-900" data-lead='${JSON.stringify(lead)}'>View</button>
            </td>
        `;
        tbody.appendChild(row);
    });

    console.log('[Render] Attaching event listeners...');
    document.querySelectorAll('.status-dropdown').forEach(dropdown => {
        dropdown.addEventListener('change', updateLeadStatus);
    });
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', e => showLeadModal(JSON.parse(e.target.dataset.lead)));
    });
}

// --- Update lead status ---
async function updateLeadStatus(e) {
    const leadId = e.target.dataset.leadId;
    const newStatus = e.target.value;

    console.log(`[Update] Updating lead ${leadId} to status "${newStatus}"`);

    const { error } = await supabase
        .from('leads')
        .update({ status: newStatus })
        .eq('id', leadId);

    if (error) {
        console.error('[Update] Error updating lead:', error);
    } else {
        console.log('[Update] Status updated successfully');
        loadLeads();
    }
}

// --- Modal ---
function showLeadModal(lead) {
    console.log('[Modal] Showing lead:', lead);
    const modal = document.getElementById('leadModal');
    const details = document.getElementById('leadDetails');

    let formDataHtml = '';
    if (lead.form_data && Object.keys(lead.form_data).length > 0) {
        formDataHtml = '<div class="mt-4"><h4 class="font-medium text-gray-900 mb-2">Form Data:</h4>';
        for (const [key, value] of Object.entries(lead.form_data)) {
            formDataHtml += `<p class="text-sm text-gray-600"><strong>${key}:</strong> ${value}</p>`;
        }
        formDataHtml += '</div>';
    }

    details.innerHTML = `
        <div class="space-y-3">
            <p class="text-sm text-gray-600"><strong>Name:</strong> ${lead.name || '-'}</p>
            <p class="text-sm text-gray-600"><strong>Email:</strong> ${lead.email || '-'}</p>
            <p class="text-sm text-gray-600"><strong>Phone:</strong> ${lead.phone || '-'}</p>
            <p class="text-sm text-gray-600"><strong>Form Type:</strong> ${lead.form_type || '-'}</p>
            <p class="text-sm text-gray-600"><strong>Status:</strong> ${lead.status}</p>
            <p class="text-sm text-gray-600"><strong>Date:</strong> ${new Date(lead.created_at).toLocaleString()}</p>
            ${formDataHtml}
        </div>
    `;
    modal.classList.remove('hidden');
}

document.getElementById('closeModal').addEventListener('click', () => {
    console.log('[Modal] Closing modal');
    document.getElementById('leadModal').classList.add('hidden');
});

// --- Search/filter ---
document.getElementById('searchInput').addEventListener('input', e => {
    console.log('[Filter] Search input:', e.target.value);
    filterLeads(e.target.value.toLowerCase(), document.getElementById('statusFilter').value);
});
document.getElementById('statusFilter').addEventListener('change', e => {
    console.log('[Filter] Status filter changed:', e.target.value);
    filterLeads(document.getElementById('searchInput').value.toLowerCase(), e.target.value);
});

function filterLeads(searchTerm, statusFilter) {
    console.log('[Filter] Filtering leads', searchTerm, statusFilter);
    let filtered = allLeads;
    if (searchTerm) filtered = filtered.filter(l => (l.name?.toLowerCase().includes(searchTerm) || l.email?.toLowerCase().includes(searchTerm) || l.phone?.toLowerCase().includes(searchTerm)));
    if (statusFilter) filtered = filtered.filter(l => l.status === statusFilter);
    console.log('[Filter] Leads after filter:', filtered.length);
    renderLeads(filtered);
}

function getStatusColor(status) {
    switch(status) {
        case 'new': return 'bg-yellow-100 text-yellow-800';
        case 'contacted': return 'bg-blue-100 text-blue-800';
        case 'booked': return 'bg-green-100 text-green-800';
        case 'lost': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

// --- Logout ---
document.getElementById('logoutBtn').addEventListener('click', async () => {
    console.log('[Auth] Logging out...');
    await supabase.auth.signOut();
    window.location.href = 'login.html';
});

checkAuth();
</script>
