<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leads - QuoteFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50">
    <div class="flex h-screen overflow-hidden">
        <div class="w-64 bg-gray-900">
            <div class="flex flex-col h-full">
                <div class="flex items-center justify-center h-16 bg-gray-800">
                    <span class="text-white text-xl font-bold">QuoteFlow</span>
                </div>
                <nav class="flex-1 px-2 py-4 space-y-1">
                    <a href="dashboard.html" class="text-gray-300 hover:bg-gray-700 hover:text-white group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                        <span>Dashboard</span>
                    </a>
                    <a href="leads.html" class="bg-gray-800 text-white group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                        <span>Leads</span>
                    </a>
                    <a href="form-builder.html" class="text-gray-300 hover:bg-gray-700 hover:text-white group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                        <span>Form Builder</span>
                    </a>
                    <a href="settings.html" class="text-gray-300 hover:bg-gray-700 hover:text-white group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                        <span>Settings</span>
                    </a>
                </nav>
                <div class="p-4">
                    <button id="logoutBtn" class="w-full bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition">
                        Logout
                    </button>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-auto">
            <div class="py-6">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <h1 class="text-2xl font-semibold text-gray-900">All Leads</h1>
                </div>
                <div class="max-w-7xl mx-auto px-4 sm:px-6 md:px-8">
                    <div class="py-4">
                        <div class="bg-white shadow rounded-xl">
                            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1 min-w-0">
                                        <input type="text" id="searchInput" placeholder="Search leads..." class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md px-4 py-2">
                                    </div>
                                    <div class="ml-4">
                                        <select id="statusFilter" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md px-4 py-2">
                                            <option value="">All Status</option>
                                            <option value="new">New</option>
                                            <option value="contacted">Contacted</option>
                                            <option value="booked">Booked</option>
                                            <option value="lost">Lost</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Form Type</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="leadsTable" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="leadModal" class="hidden fixed z-10 inset-0 overflow-y-auto">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Lead Details</h3>
                            <div id="leadDetails" class="mt-2">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="closeModal" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://jpchpqjnyabtpptufkcj.supabase.co';  // ✅ Correct URL with quotes
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';  // ✅ Correct anon key (JWT token)
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);  // ✅ Using the constants

        let accountId = null;
        let allLeads = [];

        async function checkAuth() {
            const { data: { user } } = await supabase.auth.getUser();
            
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            const { data: account } = await supabase
                .from('accounts')
                .select('*')
                .eq('owner_id', user.id)
                .single();

            if (account) {
                accountId = account.id;
                loadLeads();
            }
        }

        async function loadLeads() {
            const { data: leads } = await supabase
                .from('leads')
                .select('*')
                .eq('account_id', accountId)
                .order('created_at', { ascending: false });

            if (leads) {
                allLeads = leads;
                renderLeads(leads);
            }
        }

        function renderLeads(leads) {
            const tbody = document.getElementById('leadsTable');
            tbody.innerHTML = '';

            leads.forEach(lead => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${lead.name || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lead.email || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lead.phone || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lead.form_type || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <select class="status-dropdown text-xs leading-5 font-semibold rounded-full px-2 py-1 ${getStatusColor(lead.status)}" data-lead-id="${lead.id}" data-current-status="${lead.status}">
                            <option value="new" ${lead.status === 'new' ? 'selected' : ''}>New</option>
                            <option value="contacted" ${lead.status === 'contacted' ? 'selected' : ''}>Contacted</option>
                            <option value="booked" ${lead.status === 'booked' ? 'selected' : ''}>Booked</option>
                            <option value="lost" ${lead.status === 'lost' ? 'selected' : ''}>Lost</option>
                        </select>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(lead.created_at).toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="view-btn text-indigo-600 hover:text-indigo-900" data-lead='${JSON.stringify(lead)}'>View</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.querySelectorAll('.status-dropdown').forEach(dropdown => {
                dropdown.addEventListener('change', updateLeadStatus);
            });

            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const lead = JSON.parse(e.target.dataset.lead);
                    showLeadModal(lead);
                });
            });
        }

        async function updateLeadStatus(e) {
            const leadId = e.target.dataset.leadId;
            const newStatus = e.target.value;

            const { error } = await supabase
                .from('leads')
                .update({ status: newStatus })
                .eq('id', leadId);

            if (!error) {
                loadLeads();
            }
        }

        function showLeadModal(lead) {
            const modal = document.getElementById('leadModal');
            const details = document.getElementById('leadDetails');
            
            let formDataHtml = '';
            if (lead.form_data && Object.keys(lead.form_data).length > 0) {
                formDataHtml = '<div class="mt-4"><h4 class="font-medium text-gray-900 mb-2">Form Data:</h4>';
                for (const [key, value] of Object.entries(lead.form_data)) {
                    formDataHtml += `<p class="text-sm text-gray-600"><strong>${key}:</strong> ${value}</p>`;
                }
                formDataHtml += '</div>';
            }

            details.innerHTML = `
                <div class="space-y-3">
                    <p class="text-sm text-gray-600"><strong>Name:</strong> ${lead.name || '-'}</p>
                    <p class="text-sm text-gray-600"><strong>Email:</strong> ${lead.email || '-'}</p>
                    <p class="text-sm text-gray-600"><strong>Phone:</strong> ${lead.phone || '-'}</p>
                    <p class="text-sm text-gray-600"><strong>Form Type:</strong> ${lead.form_type || '-'}</p>
                    <p class="text-sm text-gray-600"><strong>Status:</strong> ${lead.status}</p>
                    <p class="text-sm text-gray-600"><strong>Date:</strong> ${new Date(lead.created_at).toLocaleString()}</p>
                    ${formDataHtml}
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('leadModal').classList.add('hidden');
        });

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            filterLeads(searchTerm, statusFilter);
        });

        document.getElementById('statusFilter').addEventListener('change', (e) => {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = e.target.value;
            filterLeads(searchTerm, statusFilter);
        });

        function filterLeads(searchTerm, statusFilter) {
            let filtered = allLeads;

            if (searchTerm) {
                filtered = filtered.filter(lead => 
                    (lead.name && lead.name.toLowerCase().includes(searchTerm)) ||
                    (lead.email && lead.email.toLowerCase().includes(searchTerm)) ||
                    (lead.phone && lead.phone.toLowerCase().includes(searchTerm))
                );
            }

            if (statusFilter) {
                filtered = filtered.filter(lead => lead.status === statusFilter);
            }

            renderLeads(filtered);
        }

        function getStatusColor(status) {
            switch(status) {
                case 'new': return 'bg-yellow-100 text-yellow-800';
                case 'contacted': return 'bg-blue-100 text-blue-800';
                case 'booked': return 'bg-green-100 text-green-800';
                case 'lost': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        });

        checkAuth();
    </script>
</body>
</html>
